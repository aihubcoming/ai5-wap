import{p as le,B as ee,a1 as ne,aI as ze,r as B,a4 as K,a8 as H,a9 as Oe,K as ie,g as c,aH as N,z as te,E as ae,ad as Y,bl as Te,L as ge,aK as he,bH as De,J as O,Q as we,$ as Z,a0 as re,y as $,l as Fe,b6 as Ue,b7 as Le,U as be,O as se,N as j,S as Ae,T as Be,I as W,aL as ye,a$ as Me,q as Q,cg as Ye,ch as Xe,H as Ce,ab as Ie,Z as Ze,bF as Pe,aa as $e,au as He,aG as _e,aW as ce,bb as ue,Y as Ve,ci as Ee,c3 as de,cj as Ne}from"./index-8f557042.js";import{a as je,S as We}from"./index-1b600eb6.js";import{I as Se}from"./index-cae364d9.js";import{i as Ge}from"./index-3e1fbb16.js";const ve=e=>Math.sqrt((e[0].clientX-e[1].clientX)**2+(e[0].clientY-e[1].clientY)**2),qe=e=>({x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}),oe=le("image-preview")[1],me=2.6,Ke={src:String,show:Boolean,active:Number,minZoom:N(te),maxZoom:N(te),rootWidth:N(Number),rootHeight:N(Number),disableZoom:Boolean,doubleScale:Boolean,closeOnClickImage:Boolean,closeOnClickOverlay:Boolean,vertical:Boolean};var Je=ee({props:Ke,emits:["scale","close","longPress"],setup(e,{emit:l,slots:s}){const a=ne({scale:1,moveX:0,moveY:0,moving:!1,zooming:!1,initializing:!1,imageRatio:0}),m=ze(),r=B(),I=B(),C=B(!1),f=B(!1);let p=0;const i=K(()=>{const{scale:o,moveX:n,moveY:d,moving:S,zooming:z,initializing:A}=a,q={transitionDuration:z||S||A?"0s":".3s"};return(o!==1||f.value)&&(q.transform=`matrix(${o}, 0, 0, ${o}, ${n}, ${d})`),q}),g=K(()=>{if(a.imageRatio){const{rootWidth:o,rootHeight:n}=e,d=C.value?n/a.imageRatio:o;return Math.max(0,(a.scale*d-o)/2)}return 0}),h=K(()=>{if(a.imageRatio){const{rootWidth:o,rootHeight:n}=e,d=C.value?n:o*a.imageRatio;return Math.max(0,(a.scale*d-n)/2)}return 0}),w=(o,n)=>{var d;if(o=Y(o,+e.minZoom,+e.maxZoom+1),o!==a.scale){const S=o/a.scale;if(a.scale=o,n){const z=he((d=r.value)==null?void 0:d.$el),A={x:z.width*.5,y:z.height*.5},q=a.moveX-(n.x-z.left-A.x)*(S-1),Re=a.moveY-(n.y-z.top-A.y)*(S-1);a.moveX=Y(q,-g.value,g.value),a.moveY=Y(Re,-h.value,h.value)}else a.moveX=0,a.moveY=f.value?p:0;l("scale",{scale:o,index:e.active})}},k=()=>{w(1)},_=()=>{const o=a.scale>1?1:2;w(o,o===2||f.value?{x:m.startX.value,y:m.startY.value}:void 0)};let F,U,L,v,R,x,M,V,t=!1;const u=o=>{const{touches:n}=o;if(F=n.length,F===2&&e.disableZoom)return;const{offsetX:d}=m;m.start(o),U=a.moveX,L=a.moveY,V=Date.now(),t=!1,a.moving=F===1&&(a.scale!==1||f.value),a.zooming=F===2&&!d.value,a.zooming&&(v=a.scale,R=ve(n))},P=o=>{const{touches:n}=o;if(m.move(o),a.moving){const{deltaX:d,deltaY:S}=m,z=d.value+U,A=S.value+L;if((e.vertical?m.isVertical()&&Math.abs(A)>h.value:m.isHorizontal()&&Math.abs(z)>g.value)&&!t){a.moving=!1;return}t=!0,ae(o,!0),a.moveX=Y(z,-g.value,g.value),a.moveY=Y(A,-h.value,h.value)}if(a.zooming&&(ae(o,!0),n.length===2)){const d=ve(n),S=v*d/R;x=qe(n),w(S,x)}},b=o=>{var n;const d=(n=I.value)==null?void 0:n.$el;if(!d)return;const S=d.firstElementChild,z=o.target===d,A=S==null?void 0:S.contains(o.target);!e.closeOnClickImage&&A||!e.closeOnClickOverlay&&z||l("close")},T=o=>{if(F>1)return;const n=Date.now()-V,d=250;m.isTap.value&&(n<d?e.doubleScale?M?(clearTimeout(M),M=null,_()):M=setTimeout(()=>{b(o),M=null},d):b(o):n>De&&l("longPress"))},D=o=>{let n=!1;if((a.moving||a.zooming)&&(n=!0,a.moving&&U===a.moveX&&L===a.moveY&&(n=!1),!o.touches.length)){a.zooming&&(a.moveX=Y(a.moveX,-g.value,g.value),a.moveY=Y(a.moveY,-h.value,h.value),a.zooming=!1),a.moving=!1,U=0,L=0,v=1,a.scale<1&&k();const d=+e.maxZoom;a.scale>d&&w(d,x)}ae(o,n),T(o),m.reset()},G=()=>{const{rootWidth:o,rootHeight:n}=e,d=n/o,{imageRatio:S}=a;C.value=a.imageRatio>d&&S<me,f.value=a.imageRatio>d&&S>=me,f.value&&(p=(S*o-n)/2,a.moveY=p,a.initializing=!0,Te(()=>{a.initializing=!1})),k()},E=o=>{const{naturalWidth:n,naturalHeight:d}=o.target;a.imageRatio=d/n,G()};return H(()=>e.active,k),H(()=>e.show,o=>{o||k()}),H(()=>[e.rootWidth,e.rootHeight],G),Oe("touchmove",P,{target:K(()=>{var o;return(o=I.value)==null?void 0:o.$el})}),ie({resetScale:k}),()=>{const o={loading:()=>c(ge,{type:"spinner"},null)};return c(je,{ref:I,class:oe("swipe-item"),onTouchstartPassive:u,onTouchend:D,onTouchcancel:D},{default:()=>[s.image?c("div",{class:oe("image-wrap")},[s.image({src:e.src,onLoad:E,style:i.value})]):c(Se,{ref:r,src:e.src,fit:"contain",class:oe("image",{vertical:C.value}),style:i.value,onLoad:E},o)]})}}});const[Qe,X]=le("image-preview"),ea=["show","teleport","transition","overlayStyle","closeOnPopstate"],aa={show:Boolean,loop:O,images:we(),minZoom:Z(1/3),maxZoom:Z(3),overlay:O,vertical:Boolean,closeable:Boolean,showIndex:O,className:re,closeIcon:$("clear"),transition:String,beforeClose:Function,doubleScale:O,overlayClass:re,overlayStyle:Object,swipeDuration:Z(300),startPosition:Z(0),showIndicators:Boolean,closeOnPopstate:O,closeOnClickImage:O,closeOnClickOverlay:O,closeIconPosition:$("top-right"),teleport:[String,Object]};var xe=ee({name:Qe,props:aa,emits:["scale","close","closed","change","longPress","update:show"],setup(e,{emit:l,slots:s}){const a=B(),m=B(),r=ne({active:0,rootWidth:0,rootHeight:0,disableZoom:!1}),I=()=>{if(a.value){const v=he(a.value.$el);r.rootWidth=v.width,r.rootHeight=v.height,a.value.resize()}},C=v=>l("scale",v),f=v=>l("update:show",v),p=()=>{ye(e.beforeClose,{args:[r.active],done:()=>f(!1)})},i=v=>{v!==r.active&&(r.active=v,l("change",v))},g=()=>{if(e.showIndex)return c("div",{class:X("index")},[s.index?s.index({index:r.active}):`${r.active+1} / ${e.images.length}`])},h=()=>{if(s.cover)return c("div",{class:X("cover")},[s.cover()])},w=()=>{r.disableZoom=!0},k=()=>{r.disableZoom=!1},_=()=>c(We,{ref:a,lazyRender:!0,loop:e.loop,class:X("swipe"),vertical:e.vertical,duration:e.swipeDuration,initialSwipe:e.startPosition,showIndicators:e.showIndicators,indicatorColor:"white",onChange:i,onDragEnd:k,onDragStart:w},{default:()=>[e.images.map((v,R)=>c(Je,{ref:x=>{R===r.active&&(m.value=x)},src:v,show:e.show,active:r.active,maxZoom:e.maxZoom,minZoom:e.minZoom,rootWidth:r.rootWidth,rootHeight:r.rootHeight,disableZoom:r.disableZoom,doubleScale:e.doubleScale,closeOnClickImage:e.closeOnClickImage,closeOnClickOverlay:e.closeOnClickOverlay,vertical:e.vertical,onScale:C,onClose:p,onLongPress:()=>l("longPress",{index:R})},{image:s.image}))]}),F=()=>{if(e.closeable)return c(W,{role:"button",name:e.closeIcon,class:[X("close-icon",e.closeIconPosition),Be],onClick:p},null)},U=()=>l("closed"),L=(v,R)=>{var x;return(x=a.value)==null?void 0:x.swipeTo(v,R)};return ie({resetScale:()=>{var v;(v=m.value)==null||v.resetScale()},swipeTo:L}),Fe(I),H([Ue,Le],I),H(()=>e.startPosition,v=>i(+v)),H(()=>e.show,v=>{const{images:R,startPosition:x}=e;v?(i(+x),be(()=>{I(),L(+x,{immediate:!0})})):l("close",{index:r.active,url:R[r.active]})}),()=>c(Ae,se({class:[X(),e.className],overlayClass:[X("overlay"),e.overlayClass],onClosed:U,"onUpdate:show":f},j(e,ea)),{default:()=>[F(),_(),g(),h()]})}});let J;const oa={loop:!0,images:[],maxZoom:3,minZoom:1/3,onScale:void 0,onClose:void 0,onChange:void 0,vertical:!1,teleport:"body",className:"",showIndex:!0,closeable:!1,closeIcon:"clear",transition:void 0,beforeClose:void 0,doubleScale:!0,overlayStyle:void 0,overlayClass:void 0,startPosition:0,swipeDuration:300,showIndicators:!1,closeOnPopstate:!0,closeOnClickOverlay:!0,closeIconPosition:"top-right"};function ta(){({instance:J}=Ye({setup(){const{state:e,toggle:l}=Xe(),s=()=>{e.images=[]};return()=>c(xe,se(e,{onClosed:s,"onUpdate:show":l}),null)}}))}const la=(e,l=0)=>{if(!!Me)return J||ta(),e=Array.isArray(e)?{images:e,startPosition:l}:e,J.open(Q({},oa,e)),J};Ce(xe);const[na,y,ia]=le("uploader");function fe(e,l){return new Promise(s=>{if(l==="file"){s();return}const a=new FileReader;a.onload=m=>{s(m.target.result)},l==="dataUrl"?a.readAsDataURL(e):l==="text"&&a.readAsText(e)})}function pe(e,l){return Ie(e).some(s=>s.file?Ze(l)?l(s.file):s.file.size>+l:!1)}function sa(e,l){const s=[],a=[];return e.forEach(m=>{pe(m,l)?a.push(m):s.push(m)}),{valid:s,invalid:a}}const ra=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,ca=e=>ra.test(e);function ke(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?ca(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ua=ee({props:{name:te,item:N(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:l,slots:s}){const a=()=>{const{status:i,message:g}=e.item;if(i==="uploading"||i==="failed"){const h=i==="failed"?c(W,{name:"close",class:y("mask-icon")},null):c(ge,{class:y("loading")},null),w=$e(g)&&g!=="";return c("div",{class:y("mask")},[h,w&&c("div",{class:y("mask-message")},[g])])}},m=i=>{const{name:g,item:h,index:w,beforeDelete:k}=e;i.stopPropagation(),ye(k,{args:[h,{name:g,index:w}],done:()=>l("delete")})},r=()=>l("preview"),I=()=>l("reupload"),C=()=>{if(e.deletable&&e.item.status!=="uploading"){const i=s["preview-delete"];return c("div",{role:"button",class:y("preview-delete",{shadow:!i}),tabindex:0,"aria-label":ia("delete"),onClick:m},[i?i():c(W,{name:"cross",class:y("preview-delete-icon")},null)])}},f=()=>{if(s["preview-cover"]){const{index:i,item:g}=e;return c("div",{class:y("preview-cover")},[s["preview-cover"](Q({index:i},g))])}},p=()=>{const{item:i,lazyLoad:g,imageFit:h,previewSize:w,reupload:k}=e;return ke(i)?c(Se,{fit:h,src:i.objectUrl||i.content||i.url,class:y("preview-image"),width:Array.isArray(w)?w[0]:w,height:Array.isArray(w)?w[1]:w,lazyLoad:g,onClick:k?I:r},{default:f}):c("div",{class:y("file"),style:Pe(e.previewSize)},[c(W,{class:y("file-icon"),name:"description"},null),c("div",{class:[y("file-name"),"van-ellipsis"]},[i.file?i.file.name:i.url]),f()])};return()=>c("div",{class:y("preview")},[p(),a(),C()])}});const da={name:Z(""),accept:$("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:Z(1/0),imageFit:$("cover"),resultType:$("dataUrl"),uploadIcon:$("photograph"),uploadText:String,deletable:O,reupload:Boolean,afterRead:Function,showUpload:O,modelValue:we(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:O,previewOptions:Object,previewFullImage:O,maxSize:{type:[Number,String,Function],default:1/0}};var va=ee({name:na,props:da,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:l,slots:s}){const a=B(),m=[],r=B(-1),I=B(!1),C=(t=e.modelValue.length)=>({name:e.name,index:t}),f=()=>{a.value&&(a.value.value="")},p=t=>{if(f(),pe(t,e.maxSize))if(Array.isArray(t)){const u=sa(t,e.maxSize);if(t=u.valid,l("oversize",u.invalid,C()),!t.length)return}else{l("oversize",t,C());return}if(t=ne(t),r.value>-1){const u=[...e.modelValue];u.splice(r.value,1,t),l("update:modelValue",u),r.value=-1}else l("update:modelValue",[...e.modelValue,...Ie(t)]);e.afterRead&&e.afterRead(t,C())},i=t=>{const{maxCount:u,modelValue:P,resultType:b}=e;if(Array.isArray(t)){const T=+u-P.length;t.length>T&&(t=t.slice(0,T)),Promise.all(t.map(D=>fe(D,b))).then(D=>{const G=t.map((E,o)=>{const n={file:E,status:"",message:"",objectUrl:URL.createObjectURL(E)};return D[o]&&(n.content=D[o]),n});p(G)})}else fe(t,b).then(T=>{const D={file:t,status:"",message:"",objectUrl:URL.createObjectURL(t)};T&&(D.content=T),p(D)})},g=t=>{const{files:u}=t.target;if(e.disabled||!u||!u.length)return;const P=u.length===1?u[0]:[].slice.call(u);if(e.beforeRead){const b=e.beforeRead(P,C());if(!b){f();return}if(Ve(b)){b.then(T=>{i(T||P)}).catch(f);return}}i(P)};let h;const w=()=>l("closePreview"),k=t=>{if(e.previewFullImage){const u=e.modelValue.filter(ke),P=u.map(b=>(b.objectUrl&&!b.url&&b.status!=="failed"&&(b.url=b.objectUrl,m.push(b.url)),b.url)).filter(Boolean);h=la(Q({images:P,startPosition:u.indexOf(t),onClose:w},e.previewOptions))}},_=()=>{h&&h.close()},F=(t,u)=>{const P=e.modelValue.slice(0);P.splice(u,1),l("update:modelValue",P),l("delete",t,C(u))},U=t=>{I.value=!0,r.value=t,be(()=>V())},L=()=>{I.value||(r.value=-1),I.value=!1},v=(t,u)=>{const P=["imageFit","deletable","reupload","previewSize","beforeDelete"],b=Q(j(e,P),j(t,P,!0));return c(ua,se({item:t,index:u,onClick:()=>l(e.reupload?"clickReupload":"clickPreview",t,C(u)),onDelete:()=>F(t,u),onPreview:()=>k(t),onReupload:()=>U(u)},j(e,["name","lazyLoad"]),b),j(s,["preview-cover","preview-delete"]))},R=()=>{if(e.previewImage)return e.modelValue.map(v)},x=t=>l("clickUpload",t),M=()=>{const t=e.modelValue.length<+e.maxCount,u=e.readonly?null:c("input",{ref:a,type:"file",class:y("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&r.value===-1,disabled:e.disabled,onChange:g,onClick:L},null);return s.default?ce(c("div",{class:y("input-wrapper"),onClick:x},[s.default(),u]),[[ue,t]]):ce(c("div",{class:y("upload",{readonly:e.readonly}),style:Pe(e.previewSize),onClick:x},[c(W,{name:e.uploadIcon,class:y("upload-icon")},null),e.uploadText&&c("span",{class:y("upload-text")},[e.uploadText]),u]),[[ue,e.showUpload&&t]])},V=()=>{a.value&&!e.disabled&&a.value.click()};return He(()=>{m.forEach(t=>URL.revokeObjectURL(t))}),ie({chooseFile:V,reuploadFile:U,closeImagePreview:_}),_e(()=>e.modelValue),()=>c("div",{class:y()},[c("div",{class:y("wrapper",{disabled:e.disabled})},[R(),M()])])}});const wa=Ce(va),ba=(e,l)=>{const s=e.file.size/1024/1024<30;if(console.log(s),!s)return Ee("\u4E0A\u4F20\u56FE\u7247\u5927\u5C0F\u4E0D\u80FD\u8D85\u8FC7 30MB!"),!1;let a=.6;return e.file.size>512*1024&&(a=.1),new Promise((m,r)=>{Ge.exports.compress(e.file,a).then(I=>{const C=new FormData;C.append("file",I),console.log(de),Ne.post(`${de}/api/api/uploadFile`,C,{timeout:1e4,headers:{"Content-Type":"multipart/form-data"},onDownloadProgress:f=>{console.log(f),f.lengthComputeable&&l((f.loaded/f.total*100).toFixed(2))}}).then(f=>{const{code:p,data:i}=f.data;p/1===0?m(i.path):r(f.data)}).catch(f=>{r(f)})})})};export{wa as U,ba as _,la as s};
